<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navratri Welcome - Department of CSD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #8a2be2;
            --secondary: #4b0082;
            --accent: #ff6b6b;
            --light: #ffffff;
            --dark: #1a1a2e;
            --gold: #ffd700;
            --rangoli-orange: #ff9800;
            --rangoli-pink: #e91e63;
            --rangoli-green: #4caf50;
        }

        /* Animated Gradient Background */
        body {
            background: linear-gradient(135deg, #8a2be2, #4b0082, #ff6b6b, #4b0082);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating Lights */
        .light {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,215,0,0) 70%);
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }

        .light:nth-child(1) { width: 100px; height: 100px; top: 10%; left: 5%; animation-delay: 0s; }
        .light:nth-child(2) { width: 150px; height: 150px; top: 20%; right: 10%; animation-delay: 1s; }
        .light:nth-child(3) { width: 80px; height: 80px; bottom: 15%; left: 15%; animation-delay: 2s; }
        .light:nth-child(4) { width: 120px; height: 120px; bottom: 25%; right: 5%; animation-delay: 3s; }
        .light:nth-child(5) { width: 90px; height: 90px; top: 40%; left: 20%; animation-delay: 4s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.7; }
            50% { transform: translateY(-20px) scale(1.1); opacity: 1; }
        }

        /* Music Control */
        .music-control {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .music-button {
            background: linear-gradient(135deg, var(--rangoli-orange), var(--rangoli-pink));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
            transition: all 0.3s ease;
        }

        .music-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
        }

        .music-button.playing {
            background: linear-gradient(135deg, var(--rangoli-green), var(--rangoli-orange));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Music Animation */
        .music-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .music-animation.active {
            opacity: 1;
        }

        .music-note {
            position: absolute;
            font-size: 2rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            animation: floatNote 4s linear infinite;
            opacity: 0;
        }

        .music-note:nth-child(1) { top: 10%; left: 5%; animation-delay: 0s; }
        .music-note:nth-child(2) { top: 20%; right: 15%; animation-delay: 1s; }
        .music-note:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 2s; }
        .music-note:nth-child(4) { bottom: 15%; right: 10%; animation-delay: 3s; }
        .music-note:nth-child(5) { top: 40%; left: 80%; animation-delay: 0.5s; }

        @keyframes floatNote {
            0% {
                transform: translateY(100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 3;
            position: relative;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 10px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--gold);
            filter: drop-shadow(0 0 10px var(--gold));
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--gold), var(--light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 70vh;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .music-control {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                display: flex;
                justify-content: center;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Durga Container with Flower Effects */
        .durga-container {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #durga-image {
            max-height: 80%;
            max-width: 80%;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
            z-index: 2;
        }

        #flower-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .light-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: all 2s ease;
            z-index: 3;
        }

        .light-effect.active {
            width: 300px;
            height: 300px;
            opacity: 1;
        }

        /* Camera - Rectangular Frame */
        .camera-container {
            position: relative;
            width: 100%;
            height: 400px; /* Rectangular height */
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcam, #capture-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 15px;
        }

        .camera-placeholder {
            color: white;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Buttons */
        .capture-button {
            background: linear-gradient(135deg, var(--accent), #ff5252);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .capture-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .capture-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .download-button {
            background: linear-gradient(135deg, var(--rangoli-orange), var(--rangoli-pink));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
            background: linear-gradient(135deg, var(--rangoli-pink), var(--rangoli-orange));
        }

        /* Welcome by CSD Section */
        .csd-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .namaste-gif {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            box-shadow: 0 0 15px var(--gold);
        }

        .csd-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 10px 0;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left: 4px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Enhanced Poster */
        .poster-container {
            display: none;
            position: relative;
            width: 100%;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            margin-top: 20px;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .poster-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(139, 0, 139, 0.6) 0%, 
                rgba(255, 105, 180, 0.6) 50%, 
                rgba(255, 215, 0, 0.6) 100%);
            opacity: 0.9;
            z-index: 1;
        }

        .poster-content {
            position: relative;
            z-index: 3;
            padding: 40px 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .poster-header {
            margin-bottom: 30px;
            position: relative;
            width: 100%;
        }

        .poster-header h2 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--gold), var(--rangoli-orange), var(--rangoli-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-weight: 800;
        }

        .poster-header p {
            font-size: 1.4rem;
            color: var(--light);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .enthusiasm-text {
            font-size: 1.2rem !important;
            font-style: italic;
            color: var(--gold) !important;
            margin-top: 10px !important;
        }

        .rangoli-border {
            width: 80%;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--rangoli-orange), 
                var(--gold), 
                var(--rangoli-pink), 
                transparent);
            margin: 20px auto;
            border-radius: 2px;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
        }

        /* Perfect Photo Alignment */
        .poster-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 30px 0;
        }

        .poster-image-frame {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
        }

        #poster-photo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 15px;
            z-index: 2;
            background: transparent;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: filter 0.5s ease;
        }

        #poster-photo.brightened {
            filter: brightness(1.2) contrast(1.1);
        }

        .photo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 3px solid transparent;
            border-image: linear-gradient(45deg, var(--gold), var(--rangoli-orange), var(--rangoli-pink)) 1;
            border-radius: 20px;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.6),
                inset 0 0 30px rgba(255, 215, 0, 0.3);
            z-index: 1;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 
                    0 0 20px rgba(255, 215, 0, 0.6),
                    inset 0 0 20px rgba(255, 215, 0, 0.3);
            }
            to {
                box-shadow: 
                    0 0 40px rgba(255, 215, 0, 0.8),
                    inset 0 0 40px rgba(255, 215, 0, 0.5);
            }
        }

        .poster-quote {
            font-style: italic;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            margin: 25px 0;
            border-left: 4px solid var(--gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
        }

        .poster-quote p {
            font-size: 1.3rem;
            line-height: 1.6;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* Decorations */
        .lamp {
            position: absolute;
            bottom: 0;
            width: 50px;
            height: 70px;
            background: linear-gradient(to bottom, #ffd700, #ff6b6b);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 0 15px #ffd700;
        }

        .lamp::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 8px;
            width: 35px;
            height: 15px;
            background: #ff6b6b;
            border-radius: 50%;
        }

        .lamp.left { left: 3%; }
        .lamp.right { right: 3%; }

        .flower-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: repeating-linear-gradient(
                90deg,
                #ff6b6b,
                #ff6b6b 10px,
                #ffd700 10px,
                #ffd700 20px,
                #4b0082 20px,
                #4b0082 30px,
                #8a2be2 30px,
                #8a2be2 40px
            );
            opacity: 0.8;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            opacity: 0.8;
        }

        /* Poster Flower Animation */
        .poster-flowers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .poster-flowers.active {
            opacity: 1;
        }

        .poster-flower {
            position: absolute;
            font-size: 1.5rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            animation: floatPosterFlower 8s linear infinite;
            opacity: 0;
        }

        .poster-flower:nth-child(1) { left: 10%; animation-delay: 0s; }
        .poster-flower:nth-child(2) { left: 20%; animation-delay: 1s; }
        .poster-flower:nth-child(3) { left: 30%; animation-delay: 2s; }
        .poster-flower:nth-child(4) { left: 70%; animation-delay: 3s; }
        .poster-flower:nth-child(5) { left: 80%; animation-delay: 4s; }
        .poster-flower:nth-child(6) { left: 90%; animation-delay: 5s; }

        @keyframes floatPosterFlower {
            0% {
                transform: translateY(-50px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(600px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Camera Error Message */
        .camera-error {
            color: #ff6b6b;
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Floating Lights -->
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>

    <!-- Music Animation Elements -->
    <div id="music-animation" class="music-animation">
        <div class="music-note">♪</div>
        <div class="music-note">♫</div>
        <div class="music-note">♩</div>
        <div class="music-note">♬</div>
        <div class="music-note">♪</div>
    </div>

    <!-- Decorations -->
    <div class="decoration lamp left"></div>
    <div class="decoration lamp right"></div>
    <div class="decoration flower-banner"></div>

    <div class="container">
        <!-- Music Control -->
        <div class="music-control">
            <button id="music-btn" class="music-button">
                <i class="fas fa-play"></i>
                <span>Play Music</span>
            </button>
            <audio id="background-music" loop>
                <source src="assets/music.mp3" type="audio/mpeg">
                <source src="assets/music.mp4" type="audio/mp4">
            </audio>
            <audio id="welcome-audio">
                <source src="assets/Welcomaudio.mp4" type="audio/mp4">
            </audio>
        </div>

        <header>
            <div class="logo">
                <i class="fas fa-camera logo-icon"></i>
                <h1>Navratri Welcome</h1>
            </div>
            <p>Department of CSD Festival Celebration</p>
        </header>

        <div class="main-content">
            <!-- Left Panel: Goddess Durga with Flower Effects -->
            <div class="panel left-panel">
                <div class="durga-container">
                    <img src="assets/images/durga.png" alt="Goddess Durga" id="durga-image">
                    <canvas id="flower-canvas"></canvas>
                    <div class="light-effect" id="light-effect"></div>
                </div>
            </div>

            <!-- Center Panel: Camera and Poster -->
            <div class="panel center-panel">
                <div class="camera-container">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="capture-canvas"></canvas>
                </div>
                
                <button id="capture-btn" class="capture-button">
                    <i class="fas fa-camera"></i> Take Photo
                </button>
                
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <span>Removing background and creating poster</span>
                    <span class="loading-dots"></span>
                </div>

                <!-- Welcome by CSD Section -->
                <div class="CSD-welcome">
                    <img src="assets/gifs/namaste.gif" alt="Namaste" class="namaste-gif">
                    <div class="csd-text">Welcome by CSD</div>
                </div>
                
                <!-- Poster will appear here after photo -->
                <div class="poster-container" id="poster-container">
                    <!-- Poster Flower Animation -->
                    <div class="poster-flowers" id="poster-flowers">
                        <div class="poster-flower">🌸</div>
                        <div class="poster-flower">🌺</div>
                        <div class="poster-flower">🌼</div>
                        <div class="poster-flower">🌷</div>
                        <div class="poster-flower">💮</div>
                        <div class="poster-flower">🏵️</div>
                    </div>
                    
                    <div class="poster-background"></div>
                    <div class="poster-content">
                        <div class="poster-header">
                            <h2>Welcome to CSD Department</h2>
                            <p>Have a Happy Navratri!</p>
                            <p class="enthusiasm-text">Let's celebrate with full enthusiasm!</p>
                            <div class="rangoli-border"></div>
                        </div>
                        <div class="poster-image-container">
                            <div class="poster-image-frame">
                                <img id="poster-photo" alt="Your Photo">
                                <div class="photo-glow"></div>
                            </div>
                        </div>
                        <div class="poster-quote">
                            <p id="poster-quote-text">Loading quote...</p>
                        </div>
                        <button id="download-btn" class="download-button">
                            <i class="fas fa-download"></i> Download Poster
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Made with ❤️ for Navratri Celebrations | Department of CSD</p>
        </footer>
    </div>

    <!-- Hidden canvas for poster download -->
    <canvas id="download-canvas" style="display: none;"></canvas>

    <script>
        // All the elements we need
        const webcam = document.getElementById('webcam');
        const captureCanvas = document.getElementById('capture-canvas');
        const captureCtx = captureCanvas.getContext('2d');
        const captureBtn = document.getElementById('capture-btn');
        const loading = document.getElementById('loading');
        const posterContainer = document.getElementById('poster-container');
        const posterPhoto = document.getElementById('poster-photo');
        const posterQuoteText = document.getElementById('poster-quote-text');
        const lightEffect = document.getElementById('light-effect');
        const downloadBtn = document.getElementById('download-btn');
        const posterFlowers = document.getElementById('poster-flowers');

        // Music elements
        const musicBtn = document.getElementById('music-btn');
        const backgroundMusic = document.getElementById('background-music');
        const welcomeAudio = document.getElementById('welcome-audio');
        const musicAnimation = document.getElementById('music-animation');

        // Your API Key for background removal
        const BG_REMOVE_API_KEY = 'iMYAfUDV78Li9jRtUNR472LM';
        const BG_REMOVE_API_URL = 'https://api.remove.bg/v1.0/removebg';

        // Flower animation variables
        let flowers = [];
        const flowerColors = ['#ff6b6b', '#ffa726', '#66bb6a', '#29b6f6', '#ab47bc'];

        // 100+ Festive Quotes
        const quotes = [
            "May Goddess Durga bless you with happiness and prosperity!",
            "Wishing you a Navratri filled with joy and celebrations!",
            "May the divine energy of Navratri bring peace to your life!",
            "Let's celebrate the victory of good over evil!",
            "May the festival lights brighten your life!",
            "Wishing you health, wealth and happiness this Navratri!",
            "May the rhythm of Garba fill your heart with joy!",
            "Embrace the festive spirit of Navratri!",
            "May Goddess Durga remove all obstacles from your life!",
            "Wishing you and your family a very Happy Navratri!",
            "May the divine blessings be with you always!",
            "Let the colors of Navratri fill your life with happiness!",
            "May this Navratri bring new beginnings!",
            "Wishing you success in all your endeavors!",
            "May the positive energy surround you!",
            "Celebrate the power of womanhood this Navratri!",
            "May your life be as colorful as Navratri!",
            "Wishing you endless joy and prosperity!",
            "May the divine light guide your path!",
            "Let's welcome Goddess Durga with open hearts!",
            "May the festival bring you closer to your dreams!",
            "Wishing you a Navratri full of love and laughter!",
            "May the divine grace be with you!",
            "Let the celebrations begin!",
            "May this Navratri be extra special for you!",
            "Wishing you divine blessings this festive season!",
            "May the nine nights bring you nine blessings!",
            "Embrace the spiritual energy of Navratri!",
            "May your heart dance to the tunes of devotion!",
            "Wishing you a Navratri filled with divine light!",
        ];

        // Camera stream variable
        let stream = null;

        // Start the app when page loads
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                await setupWebcam();
                setupFlowerAnimation();
                setupMusicControls();
                setupPosterFlowers();
                displayRandomPosterQuote();
                
                captureBtn.addEventListener('click', takePhoto);
                downloadBtn.addEventListener('click', downloadPoster);
                
                console.log('🎉 Navratri App Ready!');
            } catch (error) {
                console.error('Camera error:', error);
                showError('Camera error! Please allow camera access and make sure you are using HTTPS.');
                // Show fallback image
                showCameraFallback();
            }
        }

        // Setup Camera - SIMPLIFIED VERSION
        async function setupWebcam() {
            try {
                // Get camera access with simpler constraints
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true 
                });

                // Set video source
                webcam.srcObject = stream;

                // Wait for video to be ready
                return new Promise((resolve) => {
                    webcam.onloadedmetadata = () => {
                        // Set canvas dimensions to match video
                        captureCanvas.width = webcam.videoWidth;
                        captureCanvas.height = webcam.videoHeight;
                        console.log('Camera setup successful:', webcam.videoWidth, 'x', webcam.videoHeight);
                        resolve();
                    };

                    // Fallback in case onloadedmetadata doesn't fire
                    setTimeout(() => {
                        if (captureCanvas.width === 0) {
                            captureCanvas.width = 640;
                            captureCanvas.height = 480;
                            console.log('Using fallback camera dimensions');
                            resolve();
                        }
                    }, 1000);
                });

            } catch (error) {
                console.error('Camera setup failed:', error);
                showCameraFallback();
                throw error;
            }
        }

        // Show fallback when camera fails
        function showCameraFallback() {
            const cameraContainer = document.querySelector('.camera-container');
            cameraContainer.innerHTML = `
                <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#333; color:white; border-radius:15px;">
                    <i class="fas fa-camera-slash" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>Camera not available</p>
                    <p style="font-size:12px; margin-top:10px;">Please allow camera access and refresh</p>
                    <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#ff6b6b; border:none; border-radius:5px; color:white; cursor:pointer;">
                        Try Again
                    </button>
                </div>
            `;
            captureBtn.style.display = 'none';
        }

        // Setup Music Controls with proper looping
        function setupMusicControls() {
            let isPlaying = false;
            
            // Ensure music loops properly
            backgroundMusic.loop = true;
            
            musicBtn.addEventListener('click', () => {
                if (isPlaying) {
                    // Stop music
                    backgroundMusic.pause();
                    backgroundMusic.currentTime = 0;
                    musicBtn.innerHTML = '<i class="fas fa-play"></i><span>Play Music</span>';
                    musicBtn.classList.remove('playing');
                    musicAnimation.classList.remove('active');
                    isPlaying = false;
                } else {
                    // Play music
                    backgroundMusic.play().then(() => {
                        musicBtn.innerHTML = '<i class="fas fa-stop"></i><span>Stop Music</span>';
                        musicBtn.classList.add('playing');
                        musicAnimation.classList.add('active');
                        isPlaying = true;
                    }).catch(error => {
                        showError('Music playback failed. Please interact with the page first.');
                    });
                }
            });
            
            // Handle music errors
            backgroundMusic.addEventListener('error', (e) => {
                console.error('Music error:', e);
                showError('Music file not found. Please check assets/music.mp3');
            });
        }

        // Flower animation for Durga section
        function setupFlowerAnimation() {
            const flowerCanvas = document.getElementById('flower-canvas');
            if (!flowerCanvas) return;
            
            const flowerCtx = flowerCanvas.getContext('2d');
            
            flowerCanvas.width = flowerCanvas.offsetWidth || 300;
            flowerCanvas.height = flowerCanvas.offsetHeight || 400;
            
            // Create initial flowers
            for (let i = 0; i < 25; i++) {
                flowers.push(createFlower(flowerCanvas));
            }
            
            function animate() {
                flowerCtx.clearRect(0, 0, flowerCanvas.width, flowerCanvas.height);
                
                flowers.forEach((flower) => {
                    flower.y += flower.speed;
                    flower.rotation += flower.rotationSpeed;
                    
                    if (flower.y > flowerCanvas.height) {
                        Object.assign(flower, createFlower(flowerCanvas));
                        flower.y = -20;
                    }
                    
                    drawFlower(flowerCtx, flower);
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        function createFlower(canvas) {
            return {
                x: Math.random() * (canvas.width || 300),
                y: Math.random() * (canvas.height || 400),
                size: 5 + Math.random() * 10,
                speed: 1 + Math.random() * 2,
                rotation: Math.random() * Math.PI * 2,
                rotationSpeed: (Math.random() - 0.5) * 0.1,
                color: flowerColors[Math.floor(Math.random() * flowerColors.length)],
                opacity: 0.5 + Math.random() * 0.5
            };
        }

        function drawFlower(ctx, flower) {
            ctx.save();
            ctx.translate(flower.x, flower.y);
            ctx.rotate(flower.rotation);
            ctx.fillStyle = flower.color;
            ctx.globalAlpha = flower.opacity;
            
            // Draw flower petals
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (i * 2 * Math.PI) / 5;
                const petalX = Math.cos(angle) * flower.size;
                const petalY = Math.sin(angle) * flower.size;
                ctx.arc(petalX, petalY, flower.size/2, 0, Math.PI * 2);
            }
            ctx.fill();
            
            // Flower center
            ctx.beginPath();
            ctx.fillStyle = '#ffd700';
            ctx.arc(0, 0, flower.size/4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        // Setup poster flower animation
        function setupPosterFlowers() {
            const posterFlowerElements = document.querySelectorAll('.poster-flower');
            posterFlowerElements.forEach((flower, index) => {
                flower.style.animationDelay = `${index * 0.5}s`;
            });
        }

        // Take photo function - FIXED
        async function takePhoto() {
            try {
                // Check if camera is working
                if (!stream) {
                    showError('Camera not available. Please refresh and allow camera access.');
                    return;
                }

                captureBtn.disabled = true;
                loading.style.display = 'flex';
                captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Capture current frame from video
                captureCtx.drawImage(webcam, 0, 0, captureCanvas.width, captureCanvas.height);
                
                // Convert to blob for API
                const photoData = captureCanvas.toDataURL('image/jpeg', 0.9);

                console.log('Starting background removal...');
                
                // Remove background using REAL API
                const photoWithoutBackground = await removeBackgroundWithAPI(photoData);
                
                console.log('Background removal successful!');
                
                // Show the poster with background removed
                posterPhoto.onload = function() {
                    // Ensure perfect fit
                    this.style.maxWidth = '100%';
                    this.style.maxHeight = '100%';
                    this.style.objectFit = 'contain';
                    // Brighten the face
                    this.classList.add('brightened');
                };
                posterPhoto.src = photoWithoutBackground;
                posterContainer.style.display = 'block';
                posterFlowers.classList.add('active');
                
                // Play welcome audio
                welcomeAudio.play().catch(e => {
                    console.log('Welcome audio not available:', e);
                });
                
                // Trigger blessing animation
                triggerBlessingAnimation();
                
                // Scroll to poster
                posterContainer.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                showError('Background removal failed. Using original photo.');
                // Fallback to original photo
                posterPhoto.src = captureCanvas.toDataURL('image/jpeg');
                posterContainer.style.display = 'block';
                posterFlowers.classList.add('active');
            } finally {
                captureBtn.disabled = false;
                loading.style.display = 'none';
                captureBtn.innerHTML = '<i class="fas fa-camera"></i> Take Photo';
            }
        }

        // Remove Background using REAL Remove.bg API - FIXED VERSION
        async function removeBackgroundWithAPI(imageData) {
            try {
                // Convert base64 to blob
                const response = await fetch(imageData);
                const blob = await response.blob();
                
                // Create FormData for API request
                const formData = new FormData();
                formData.append('image_file', blob);
                formData.append('size', 'auto');
                
                console.log('Sending request to Remove.bg API...');
                
                // Make API request
                const apiResponse = await fetch(BG_REMOVE_API_URL, {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': BG_REMOVE_API_KEY,
                    },
                    body: formData
                });
                
                if (!apiResponse.ok) {
                    const errorText = await apiResponse.text();
                    throw new Error(`API Error: ${apiResponse.status} - ${errorText}`);
                }
                
                console.log('API response received successfully');
                
                // Get the result blob
                const resultBlob = await apiResponse.blob();
                const resultUrl = URL.createObjectURL(resultBlob);
                
                return resultUrl;
                
            } catch (error) {
                console.error('API call failed:', error);
                
                // Fallback to simulated removal
                console.log('Using fallback background removal...');
                return simulateBackgroundRemoval(imageData);
            }
        }

        // Fallback: Simulate background removal
        function simulateBackgroundRemoval(imageData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    // Simple background removal simulation
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                        if (brightness > 200) {
                            data[i+3] = 0;
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = imageData;
            });
        }

        // Trigger blessing animation
        function triggerBlessingAnimation() {
            if (lightEffect) {
                lightEffect.classList.add('active');
                setTimeout(() => {
                    lightEffect.classList.remove('active');
                }, 3000);
            }
        }

        // Download poster function
        function downloadPoster() {
            try {
                // Create a temporary canvas for the full poster
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Set canvas size for high-quality download
                tempCanvas.width = 1200;
                tempCanvas.height = 1600;
                
                // Create poster background gradient
                const gradient = tempCtx.createLinearGradient(0, 0, tempCanvas.width, tempCanvas.height);
                gradient.addColorStop(0, '#8a2be2');
                gradient.addColorStop(0.5, '#4b0082');
                gradient.addColorStop(1, '#ff6b6b');
                
                tempCtx.fillStyle = gradient;
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Add decorative elements
                addPosterDecorations(tempCtx, tempCanvas);
                
                // Add text content
                tempCtx.fillStyle = '#ffffff';
                tempCtx.textAlign = 'center';
                
                // Title
                tempCtx.font = 'bold 60px Arial';
                tempCtx.fillText('Welcome to CSD Department', tempCanvas.width / 2, 150);
                
                // Subtitle
                tempCtx.font = 'italic 40px Arial';
                tempCtx.fillText('Have a Happy Navratri!', tempCanvas.width / 2, 220);
                
                // Enthusiasm text
                tempCtx.font = '30px Arial';
                tempCtx.fillText("Let's celebrate with full enthusiasm!", tempCanvas.width / 2, 270);
                
                // Add the user's photo
                const img = new Image();
                img.onload = function() {
                    // Center the photo perfectly
                    const photoWidth = 600;
                    const photoHeight = 600;
                    const x = (tempCanvas.width - photoWidth) / 2;
                    const y = 350;
                    
                    // Add photo frame
                    tempCtx.strokeStyle = '#ffd700';
                    tempCtx.lineWidth = 10;
                    tempCtx.strokeRect(x - 5, y - 5, photoWidth + 10, photoHeight + 10);
                    
                    // Draw the photo
                    tempCtx.drawImage(img, x, y, photoWidth, photoHeight);
                    
                    // Add quote
                    tempCtx.font = 'italic 32px Arial';
                    tempCtx.fillStyle = '#ffd700';
                    tempCtx.fillText(posterQuoteText.textContent, tempCanvas.width / 2, 1100);
                    
                    // Add footer
                    tempCtx.font = '20px Arial';
                    tempCtx.fillStyle = '#ffffff';
                    tempCtx.fillText('Made with ❤️ for Navratri Celebrations', tempCanvas.width / 2, 1250);
                    tempCtx.fillText('Department of CSD', tempCanvas.width / 2, 1280);
                    
                    // Download the image
                    const link = document.createElement('a');
                    link.download = 'navratri-poster.png';
                    link.href = tempCanvas.toDataURL('image/png');
                    link.click();
                };
                
                img.src = posterPhoto.src;
                
            } catch (error) {
                console.error('Download error:', error);
                showError('Download failed. Please try again.');
            }
        }

        // Add decorative elements to poster
        function addPosterDecorations(ctx, canvas) {
            // Add rangoli pattern border
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
            
            // Add decorative corners
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(45, 45, 10, 10);
            ctx.fillRect(canvas.width - 55, 45, 10, 10);
            ctx.fillRect(45, canvas.height - 55, 10, 10);
            ctx.fillRect(canvas.width - 55, canvas.height - 55, 10, 10);
        }

        // Show random quotes
        function displayRandomPosterQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            if (posterQuoteText) {
                posterQuoteText.textContent = quotes[randomIndex];
            }
        }

        // Show error messages
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff6b6b;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 1000;
                max-width: 300px;
                text-align: center;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Clean up when page unloads
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>